# yaml-language-server: $schema=https://taskfile.dev/schema.json
---
version: "3.44"

env:
  PULUMI_SKIP_UPDATE_CHECK: true

tasks:
  npm-install:
    internal: true
    run: once
    deps:
      - :asdf-install
    cmds:
      - npm ci --include=dev
    sources:
      - "package-lock.json"

  pulumi-install:
    internal: true
    run: once
    deps:
      - npm-install
    cmds:
      - pulumi install --no-dependencies
    sources:
      - "Pulumi.yaml"

  lint:
    desc: "Run eslint"
    deps:
      - npm-install
    cmds:
      - npx eslint .

  list:
    desc: "List stacks"
    deps:
      - :asdf-install
    cmds:
      - pulumi stack ls

  select:
    desc: "Select pulumi stack"
    deps:
      - :asdf-install
    cmds:
      - pulumi stack select {{.CLI_ARGS}}
    interactive: true

  ensure-select:
    internal: true
    deps:
      - :asdf-install
    cmds:
      - pulumi stack select
    status:
      - pulumi stack --show-name --non-interactive > /dev/null 2>&1

  preview:
    desc: "Pulumi preview"
    summary: |
      Preview pulumi deployment
    deps:
      - pulumi-install
      - ensure-select
    cmds:
      - pulumi preview {{.CLI_ARGS}}

  up:
    desc: "Pulumi up"
    summary: |
      Deploy pulumi stack
    deps:
      - pulumi-install
      - ensure-select
    cmds:
      - "pulumi up {{.CLI_ARGS}}"
    interactive: true
