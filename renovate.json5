{
  $schema: "https://docs.renovatebot.com/renovate-schema.json",
  extends: [
    "config:recommended",
    "docker:enableMajor",
    "docker:pinDigests",
    "helpers:pinGitHubActionDigests",
    ":semanticCommitTypeAll(chore)",
  ],
  customManagers: [
    {
      customType: "regex",
      description: "Process annotated dependencies with github-releases datasource",
      managerFilePatterns: [
        "/\\.env(?:\\.j2)?$/",
        "/\\.sh(?:\\.j2)?$/",
        "/\\.yaml(?:\\.j2)?$/",
        "/\\.toml(?:\\.j2)?$/",
      ],
      matchStrings: [
        // Matches examples like:
        // # renovate: datasource=github-releases depName=foo/bar
        // foobar_version: v1.0.0
        // # renovate: datasource=github-releases depName=foo/bar
        // FOOBAR_VERSION=v1.0.0
        "# renovate datasource=github-releases depName=(?<depName>\\S+)\\n.+(:\\s|=)(&\\S+\\s)?(?<currentValue>\\S+)",
      ],
      datasourceTemplate: "github-releases",
    },
    {
      customType: "regex",
      description: "Process annotated yaml config for docker dependencies with digest pinning support",
      managerFilePatterns: [
        "/\\.env(?:\\.j2)?$/",
        "/\\.sh(?:\\.j2)?$/",
        "/\\.yaml(?:\\.j2)?$/",
        "/\\.toml(?:\\.j2)?$/",
      ],
      // Required for digest support
      matchStringsStrategy: "recursive",
      matchStrings: [
        // Matches examples like:
        // # renovate: datasource=docker depName=ghcr.io/foo/bar
        // foobar_version: v1.0.0
        // # renovate: datasource=docker depName=ghcr.io/foo/bar
        // FOOBAR_VERSION=v1.0.0
        // Step 1: Capture depName and the specific value field (dockerTagValue), See: https://regex101.com/r/wo8lVt/1
        "# renovate: datasource=docker depName=(?<depName>\\S+)\\n(\\s*\\w[\\w_.-]*:?[\\w_.-]*:\\s+|\\w[\\w_]*=)(?<dockerTagValue>[\"']?[^'\"\\s]+(?:@sha256:[a-f0-9]+)?[\"']?)",
        // Step 2: Extract current parts from the dockerTagValue window (ensuring currentValue does not match @)
        "(?<currentValue>[^'\"\\s@]+)(?:@(?<currentDigest>sha256:[a-f0-9]+))?",
      ],
      // Replaces the match from the last matchString only
      autoReplaceStringTemplate: "{{{newValue}}}{{#if newDigest}}@{{{newDigest}}}{{/if}}",
      datasourceTemplate: "docker",
    },
    {
      customType: "jsonata",
      description: "Process terraform-provider dependencies in Pulumi YAML files",
      fileFormat: "yaml",
      managerFilePatterns: ["**/Pulumi.yaml", "**/Pulumi.yml"],
      matchStrings: [
        'packages.*[source="terraform-provider"].{ "depName": parameters[0], "currentValue": parameters[1]}',
      ],
      datasourceTemplate: "terraform-provider",
    },
  ],
  ignorePaths: ["management/truenas/docker-compose.*"],
  labels: ["dependencies"],
  packageRules: [
    // mark major version updates as "fix" commits, revisit this later
    {
      matchDepTypes: ["dependencies"],
      description: "Only major version updated will be marked as fix",
      major: {
        semanticCommitType: "fix",
      },
    },
    // schedule docker updates to weekends
    {
      matchDatasources: ["docker"],
      description: "Weekly updates for docker dependencies",
      schedule: ["* * * * 0,6"],
    },
    // mise updates
    {
      matchManagers: ["mise"],
      description: "Mise tools updates monthly",
      schedule: ["* 17-23 6 * *", "* 00-07 7 * *"],
    },
    // Deal with npm dependencies for Pulumi
    {
      matchDatasources: ["npm"],
      commitMessageTopic: "npm package {{depName}}",
      description: "Monthly updates on the 7th for npm dependencies",
      minimumReleaseAge: "5 days",
      labels: ["dependencies"],
      schedule: ["* 17-23 6 * *", "* 00-07 7 * *"],
    },
    {
      matchDatasources: ["npm"],
      matchDepTypes: ["devDependencies", "dev-dependencies", "dev"],
      description: "Group npm dev dependencies",
      groupName: "npm dev dependencies",
      rangeStrategy: "pin",
    },
    {
      matchDatasources: ["npm"],
      matchDepTypes: ["dependencies"],
      description: "Group npm dependencies",
      groupName: "npm dependencies",
      rangeStrategy: "pin",
    },
    {
      matchPackageNames: ["/^node$/", "/^@types/node$/"],
      description: "Upgrade nodejs runtime and @types/node together",
      groupName: "nodejs",
    },
    // Github actions updates
    {
      matchDatasources: ["github-actions"],
      description: "Weekly updates for GitHub Action dependencies",
      minimumReleaseAge: "3 days",
      schedule: ["* * * * 0,6"],
    },
    // Changelog URLs for docker images
    {
      matchDatasources: ["docker"],
      matchDepNames: ["public.ecr.aws/docker/library/traefik"],
      description: "Get traefik changelog URL from source repository",
      sourceUrl: "https://github.com/traefik/traefik",
    },
    {
      matchDatasources: ["docker"],
      matchPackageNames: ["ghcr.io/linuxserver/plex"],
      description: "Get plex changelog URL from source repository",
      versioning: "regex:^(?<major>\\d+)\\.(?<minor>\\d+)\\.(?<patch>\\d+)\\.(?<build>\\d+)-(?<hash>\\w+)-ls(?<revision>\\d+)$",
      sourceUrl: "https://github.com/linuxserver/docker-plex",
    },
  ],
  prCreation: "not-pending",
  rebaseWhen: "conflicted",
  semanticCommits: "enabled",
  timezone: "Australia/Brisbane",
}
